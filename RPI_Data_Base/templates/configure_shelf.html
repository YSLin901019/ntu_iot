{% extends "base.html" %}

{% block title %}é…ç½®è²¨æ¶å•†å“ - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
        <a href="{{ url_for('shelves') }}" class="btn" style="background: #6c757d; color: white;">â† è¿”å›</a>
        <h2 style="margin: 0;">ğŸ“¦ é…ç½®è²¨æ¶å•†å“</h2>
    </div>

    <!-- è²¨æ¶è³‡è¨Š -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; color: #495057;">ğŸ—‚ï¸ è²¨æ¶è³‡è¨Š</h3>
        <table style="width: 100%; background: white; border-radius: 5px;">
            <tr>
                <td style="padding: 10px; font-weight: bold; width: 30%;">è²¨æ¶ ID</td>
                <td style="padding: 10px;">{{ shelf.shelf_id }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">è¨­å‚™ ID</td>
                <td style="padding: 10px;">{{ shelf.device_id }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">å€åŸŸ</td>
                <td style="padding: 10px;">{{ device.location or 'æœªåˆ†é…' }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">GPIO</td>
                <td style="padding: 10px;">{{ shelf.gpio or 'N/A' }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">æœ€å¤§è·é›¢</td>
                <td style="padding: 10px;">{{ shelf.max_distance }} cm</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">ç•¶å‰ç‹€æ…‹</td>
                <td style="padding: 10px;">
                    {% if shelf.enabled %}
                        <span class="badge badge-success">âœ… å·²å•Ÿç”¨</span>
                    {% else %}
                        <span class="badge badge-danger">âŒ å·²åœç”¨</span>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>

    {% if not shelf.enabled %}
    <!-- æœªå•Ÿç”¨è­¦å‘Š -->
    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
        <h4 style="color: #856404; margin: 0 0 10px 0;">âš ï¸ è²¨æ¶æœªå•Ÿç”¨</h4>
        <p style="color: #856404; margin: 0;">æ­¤è²¨æ¶å°šæœªå•Ÿç”¨ï¼Œç„¡æ³•é…ç½®å•†å“ã€‚è«‹å…ˆåœ¨è²¨æ¶ç®¡ç†é é¢å•Ÿç”¨æ­¤è²¨æ¶ã€‚</p>
        <a href="{{ url_for('shelves') }}" class="btn btn-warning" style="margin-top: 15px;">è¿”å›å•Ÿç”¨è²¨æ¶</a>
    </div>
    {% else %}
    
    <!-- ç•¶å‰å•†å“è³‡è¨Š -->
    {% if shelf.product_id %}
    <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8; margin-bottom: 20px;">
        <h4 style="color: #0c5460; margin: 0 0 15px 0;">ğŸ“¦ ç•¶å‰å•†å“</h4>
        <table style="width: 100%; background: white; border-radius: 5px;">
            <tr>
                <td style="padding: 10px; font-weight: bold; width: 30%;">å•†å“ ID</td>
                <td style="padding: 10px;">{{ shelf.product_id }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">å•†å“åç¨±</td>
                <td style="padding: 10px;">{{ shelf.product_name }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">å•†å“é•·åº¦</td>
                <td style="padding: 10px;">{{ shelf.product_length }} cm</td>
            </tr>
            <tr>
                <td style="padding: 10px; font-weight: bold;">åº«å­˜æ•¸é‡</td>
                <td style="padding: 10px;">{{ shelf.stock_quantity }}</td>
            </tr>
        </table>
        <button onclick="if(confirm('ç¢ºå®šè¦è§£é™¤æ­¤è²¨æ¶çš„å•†å“ç¶å®šå—ï¼Ÿ')) unbindProduct()" 
                class="btn btn-danger" style="margin-top: 15px;">
            ğŸ—‘ï¸ è§£é™¤å•†å“ç¶å®š
        </button>
    </div>
    {% endif %}

    <!-- é…ç½®å•†å“è¡¨å–® -->
    <form method="POST" style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
        <h3 style="margin-bottom: 15px; color: #495057;">
            {% if shelf.product_id %}
                ğŸ”„ æ›´æ›å•†å“
            {% else %}
                â• ç¶å®šå•†å“
            {% endif %}
        </h3>
        
        <div class="form-group">
            <label for="product_id">é¸æ“‡å•†å“ *</label>
            <select id="product_id" name="product_id" required onchange="updateProductInfo(this.value)">
                <option value="">-- è«‹é¸æ“‡å•†å“ --</option>
                {% for product in products %}
                <option value="{{ product.product_id }}" 
                        data-name="{{ product.product_name }}"
                        data-length="{{ product.product_length }}"
                        {% if shelf.product_id == product.product_id %}selected{% endif %}>
                    {{ product.product_id }} - {{ product.product_name }} ({{ product.product_length }} cm)
                </option>
                {% endfor %}
            </select>
            <small style="color: #6c757d;">é¸æ“‡è¦å­˜æ”¾åœ¨æ­¤è²¨æ¶çš„å•†å“</small>
        </div>

        <div id="product-info" style="display: none; background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
            <strong>ğŸ“‹ å•†å“è³‡è¨Šï¼š</strong>
            <div id="product-details" style="margin-top: 10px;"></div>
        </div>
        
        <div class="form-group">
            <label for="stock_quantity">åˆå§‹åº«å­˜æ•¸é‡</label>
            <input type="number" id="stock_quantity" name="stock_quantity" 
                   value="{{ shelf.stock_quantity or 0 }}" min="0">
            <small style="color: #6c757d;">è¨­å®šå•†å“çš„åˆå§‹åº«å­˜æ•¸é‡</small>
        </div>
        
        <div class="action-buttons">
            <button type="submit" class="btn btn-primary">
                {% if shelf.product_id %}
                    âœ“ æ›´æ–°å•†å“é…ç½®
                {% else %}
                    âœ“ ç¶å®šå•†å“åˆ°è²¨æ¶
                {% endif %}
            </button>
            <a href="{{ url_for('shelves') }}" class="btn" style="background: #6c757d; color: white;">å–æ¶ˆ</a>
        </div>
    </form>
    {% endif %}
</div>

{% endblock %}

{% block extra_script %}
<script>
    function updateProductInfo(productId) {
        const select = document.getElementById('product_id');
        const infoDiv = document.getElementById('product-info');
        const detailsDiv = document.getElementById('product-details');
        
        if (productId) {
            const option = select.options[select.selectedIndex];
            const name = option.dataset.name;
            const length = option.dataset.length;
            
            detailsDiv.innerHTML = `
                <table style="width: 100%;">
                    <tr>
                        <td style="padding: 5px;"><strong>å•†å“ IDï¼š</strong></td>
                        <td style="padding: 5px;">${productId}</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;"><strong>å•†å“åç¨±ï¼š</strong></td>
                        <td style="padding: 5px;">${name}</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;"><strong>å•†å“é•·åº¦ï¼š</strong></td>
                        <td style="padding: 5px;">${length} cm</td>
                    </tr>
                </table>
            `;
            infoDiv.style.display = 'block';
        } else {
            infoDiv.style.display = 'none';
        }
    }
    
    async function unbindProduct() {
        try {
            const response = await fetch('{{ url_for("configure_shelf_product", shelf_id=shelf.shelf_id) }}', {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('âœ… å•†å“ç¶å®šå·²è§£é™¤');
                location.reload();
            } else {
                alert('âŒ è§£é™¤å¤±æ•—ï¼š' + data.error);
            }
        } catch (error) {
            alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
        }
    }
    
    // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºå·²é¸å•†å“è³‡è¨Š
    window.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('product_id');
        if (select.value) {
            updateProductInfo(select.value);
        }
    });
</script>
{% endblock %}

