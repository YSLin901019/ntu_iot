{% extends "base.html" %}

{% block title %}æ–°å¢å•†å“ - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<h2>â• æ–°å¢å•†å“</h2>

<div style="background: #f1f5f9; padding: 20px; border-left: 4px solid #475569; border-radius: 5px; margin: 20px 0;">
    <h4 style="color: #1e293b; margin-bottom: 10px;">ğŸ’¡ æ–°å¢æµç¨‹</h4>
    <ol style="color: #495057; line-height: 1.8;">
        <li>å¡«å¯«å•†å“åŸºæœ¬è³‡è¨Šï¼ˆIDã€åç¨±ã€é•·åº¦ï¼‰- <strong>å¿…å¡«</strong></li>
        <li>é¸æ“‡å•†å“è¦æ”¾ç½®çš„å€åŸŸ - <strong style="color: #0891b2;">é¸å¡«ï¼Œå¯ç¨å¾Œç¶å®š</strong></li>
        <li>å¾è©²å€åŸŸçš„å¯ç”¨è²¨æ¶ä¸­é¸æ“‡ä¸€å€‹ - <strong style="color: #0891b2;">é¸å¡«</strong></li>
        <li>è¨­å®šåˆå§‹åº«å­˜æ•¸é‡ï¼ˆè‹¥ä¸ç¶å®šè²¨æ¶å‰‡é è¨­ç‚º 0ï¼‰</li>
    </ol>
    <p style="color: #64748b; margin-top: 10px; font-size: 0.95em;">
        ğŸ’¡ <strong>æç¤ºï¼š</strong>æ‚¨å¯ä»¥å…ˆå»ºç«‹å•†å“è³‡æ–™ï¼Œç¨å¾Œå†åˆ°ã€Œè²¨æ¶ç®¡ç†ã€é é¢é€²è¡Œç¶å®šã€‚
    </p>
</div>

<form method="POST" style="max-width: 700px; margin-top: 30px;">
    <!-- å•†å“åŸºæœ¬è³‡è¨Š -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; color: #495057;">ğŸ“¦ å•†å“åŸºæœ¬è³‡è¨Š</h3>
        
        <div class="form-group">
            <label for="product_id">å•†å“ ID *</label>
            <input type="text" id="product_id" name="product_id" required 
                   placeholder="ä¾‹å¦‚: P001">
        </div>
        
        <div class="form-group">
            <label for="product_name">å•†å“åç¨± *</label>
            <input type="text" id="product_name" name="product_name" required 
                   placeholder="ä¾‹å¦‚: å¯å£å¯æ¨‚">
        </div>
        
        <div class="form-group">
            <label for="product_length">å•†å“é•·åº¦ (cm) *</label>
            <input type="number" step="0.1" id="product_length" name="product_length" required 
                   placeholder="ä¾‹å¦‚: 12.5">
            <small style="color: #6c757d;">å•†å“çš„å¯¦éš›é•·åº¦ï¼Œç”¨æ–¼è¨ˆç®—è²¨æ¶å®¹é‡</small>
        </div>
        
        <div class="form-group">
            <label for="description">å•†å“æè¿°</label>
            <textarea id="description" name="description" rows="3" 
                      placeholder="é¸å¡«ï¼šè¼¸å…¥å•†å“æè¿°"></textarea>
        </div>
    </div>
    
    <!-- ä½ç½®é…ç½® -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; color: #495057;">ğŸ“ ä½ç½®é…ç½® <span style="font-size: 0.8em; color: #0891b2; font-weight: normal;">ï¼ˆé¸å¡«ï¼‰</span></h3>
        
        {% if locations %}
        <div class="form-group">
            <label for="location">é¸æ“‡å€åŸŸ</label>
            <select id="location" name="location" onchange="loadShelves(this.value)">
                <option value="">-- æš«ä¸ç¶å®šå€åŸŸ --</option>
                {% for location in locations %}
                <option value="{{ location }}">{{ location }}</option>
                {% endfor %}
            </select>
            <small style="color: #6c757d;">è‹¥æš«ä¸ç¶å®šï¼Œå¯ç¨å¾Œåœ¨ã€Œè²¨æ¶ç®¡ç†ã€ä¸­é…ç½®</small>
        </div>
        
        <div class="form-group">
            <label for="shelf_id">é¸æ“‡è²¨æ¶</label>
            <select id="shelf_id" name="shelf_id" disabled>
                <option value="">-- è«‹å…ˆé¸æ“‡å€åŸŸ --</option>
            </select>
            <small style="color: #6c757d;">è©²å€åŸŸä¸­å¯ç”¨çš„è²¨æ¶ï¼ˆæœªç¶å®šå•†å“ï¼‰</small>
        </div>
        
        <div id="shelf-info" style="display: none; background: white; padding: 15px; border-radius: 5px; margin-top: 10px;">
            <strong>ğŸ“‹ è²¨æ¶è³‡è¨Šï¼š</strong>
            <div id="shelf-details" style="margin-top: 10px;"></div>
        </div>
        {% else %}
        <div style="background: #e0f2fe; padding: 15px; border-radius: 5px; border-left: 3px solid #0891b2;">
            <strong style="color: #0e7490;">â„¹ï¸ å°šæœªé…ç½®ä»»ä½•å€åŸŸ</strong>
            <p style="color: #0e7490; margin: 5px 0;">æ‚¨ä»å¯ä»¥å…ˆå»ºç«‹å•†å“è³‡æ–™ï¼Œç¨å¾Œå†é€²è¡Œç¶å®šã€‚</p>
            <p style="color: #64748b; margin: 5px 0; font-size: 0.9em;">è‹¥è¦ç«‹å³ç¶å®šï¼Œè«‹å…ˆåœ¨ã€Œè¨­å‚™ç®¡ç†ã€ä¸­ç‚º ESP32S3 è¨­å‚™æŒ‡å®šè² è²¬å€åŸŸã€‚</p>
            <a href="{{ url_for('devices') }}" class="btn btn-info" style="margin-top: 10px;">å‰å¾€è¨­å‚™ç®¡ç†</a>
        </div>
        {% endif %}
        
        <div class="form-group">
            <label for="stock_quantity">åˆå§‹åº«å­˜æ•¸é‡</label>
            <input type="number" id="stock_quantity" name="stock_quantity" value="0" min="0">
            <small style="color: #6c757d;">è‹¥ä¸ç¶å®šè²¨æ¶ï¼Œæ­¤æ¬„ä½å°‡è¢«å¿½ç•¥ï¼ˆé è¨­ç‚º 0ï¼‰</small>
        </div>
    </div>
    
    <div class="action-buttons">
        <button type="submit" class="btn btn-primary" id="submit-btn">âœ“ æ–°å¢å•†å“</button>
        <a href="{{ url_for('products') }}" class="btn" style="background: #6c757d; color: white;">å–æ¶ˆ</a>
    </div>
</form>
{% endblock %}

{% block extra_script %}
<script>
    let shelvesData = {};
    
    // æ›´æ–°æäº¤æŒ‰éˆ•æ–‡å­—
    function updateSubmitButton() {
        const shelfSelect = document.getElementById('shelf_id');
        const submitBtn = document.getElementById('submit-btn');
        
        if (shelfSelect.value) {
            submitBtn.textContent = 'âœ“ æ–°å¢å•†å“ä¸¦ç¶å®šè²¨æ¶';
        } else {
            submitBtn.textContent = 'âœ“ æ–°å¢å•†å“ï¼ˆæš«ä¸ç¶å®šï¼‰';
        }
    }
    
    function loadShelves(location) {
        const shelfSelect = document.getElementById('shelf_id');
        const shelfInfo = document.getElementById('shelf-info');
        
        if (!location) {
            shelfSelect.innerHTML = '<option value="">-- æš«ä¸ç¶å®šè²¨æ¶ --</option>';
            shelfSelect.disabled = true;
            shelfInfo.style.display = 'none';
            updateSubmitButton();
            return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        shelfSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
        shelfSelect.disabled = true;
        
        // å¾ API ç²å–è©²å€åŸŸçš„å¯ç”¨è²¨æ¶
        fetch(`/api/shelves/by-location/${encodeURIComponent(location)}`)
            .then(response => response.json())
            .then(data => {
                if (data.count === 0) {
                    shelfSelect.innerHTML = '<option value="">-- è©²å€åŸŸæ²’æœ‰å¯ç”¨è²¨æ¶ --</option>';
                    shelfSelect.disabled = true;
                    alert(`å€åŸŸã€Œ${location}ã€ä¸­æ²’æœ‰å¯ç”¨çš„è²¨æ¶ã€‚\n\næ‚¨ä»å¯ä»¥å…ˆå»ºç«‹å•†å“ï¼Œç¨å¾Œå†ç¶å®šã€‚`);
                } else {
                    shelfSelect.innerHTML = '<option value="">-- æš«ä¸ç¶å®šè²¨æ¶ --</option>';
                    data.shelves.forEach(shelf => {
                        const option = document.createElement('option');
                        option.value = shelf.shelf_id;
                        option.textContent = `${shelf.shelf_id} (è¨­å‚™: ${shelf.device_id}, æœ€å¤§è·é›¢: ${shelf.max_distance}cm)`;
                        shelfSelect.appendChild(option);
                        
                        // å„²å­˜è²¨æ¶è³‡è¨Š
                        shelvesData[shelf.shelf_id] = shelf;
                    });
                    shelfSelect.disabled = false;
                }
                updateSubmitButton();
            })
            .catch(error => {
                console.error('Error:', error);
                shelfSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                alert('è¼‰å…¥è²¨æ¶åˆ—è¡¨å¤±æ•—ï¼š' + error);
            });
    }
    
    // ç•¶é¸æ“‡è²¨æ¶æ™‚é¡¯ç¤ºè©³ç´°è³‡è¨Š
    document.getElementById('shelf_id').addEventListener('change', function() {
        const shelfId = this.value;
        const shelfInfo = document.getElementById('shelf-info');
        const shelfDetails = document.getElementById('shelf-details');
        
        if (shelfId && shelvesData[shelfId]) {
            const shelf = shelvesData[shelfId];
            shelfDetails.innerHTML = `
                <table style="width: 100%;">
                    <tr>
                        <td style="padding: 5px;"><strong>è²¨æ¶ IDï¼š</strong></td>
                        <td style="padding: 5px;">${shelf.shelf_id}</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;"><strong>è¨­å‚™ IDï¼š</strong></td>
                        <td style="padding: 5px;">${shelf.device_id} (${shelf.device_name})</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;"><strong>æœ€å¤§è·é›¢ï¼š</strong></td>
                        <td style="padding: 5px;">${shelf.max_distance} cm</td>
                    </tr>
                    <tr>
                        <td style="padding: 5px;"><strong>ä½ç½®ç´¢å¼•ï¼š</strong></td>
                        <td style="padding: 5px;">${shelf.position_index || 'N/A'}</td>
                    </tr>
                </table>
            `;
            shelfInfo.style.display = 'block';
        } else {
            shelfInfo.style.display = 'none';
        }
        updateSubmitButton();
    });
</script>
{% endblock %}

