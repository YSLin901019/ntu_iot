{% extends "base.html" %}

{% block title %}æ„Ÿæ¸¬å™¨æ•¸æ“š - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<h2>ğŸ“ˆ æ„Ÿæ¸¬å™¨æ•¸æ“š</h2>

<div class="filter-form">
    <form method="GET" action="{{ url_for('sensor_data') }}">
        <div class="form-group">
            <label for="device_id">è¨­å‚™ ID</label>
            <select id="device_id" name="device_id">
                <option value="">-- æ‰€æœ‰è¨­å‚™ --</option>
                {% for device in devices %}
                <option value="{{ device }}" {% if device == current_device %}selected{% endif %}>{{ device }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="shelf_id">è²¨æ¶ ID</label>
            <select id="shelf_id" name="shelf_id">
                <option value="">-- æ‰€æœ‰è²¨æ¶ --</option>
                {% for shelf in shelves_list %}
                <option value="{{ shelf }}" {% if shelf == current_shelf %}selected{% endif %}>{{ shelf }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="limit">é¡¯ç¤ºç­†æ•¸</label>
            <select id="limit" name="limit">
                <option value="20" {% if limit == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary">ğŸ” ç¯©é¸</button>
    </form>
</div>

{% if data %}
<p style="color: #6c757d; margin-bottom: 10px;">
    å…± {{ data|length }} ç­†è¨˜éŒ„
    {% if current_device %}ï¼ˆè¨­å‚™: {{ current_device }}ï¼‰{% endif %}
    {% if current_shelf %}ï¼ˆè²¨æ¶: {{ current_shelf }}ï¼‰{% endif %}
</p>

<div style="overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>æ™‚é–“</th>
                <th>è¨­å‚™ ID</th>
                <th>è²¨æ¶ ID</th>
                <th>è·é›¢ (cm)</th>
                <th>å ç”¨ç‹€æ…‹</th>
                <th>å¡«å……ç‡</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr>
                <td>{{ item.timestamp }}</td>
                <td>{{ item.device_id }}</td>
                <td><strong>{{ item.shelf_id }}</strong></td>
                <td>{{ "%.1f"|format(item.distance_cm) }}</td>
                <td>
                    {% if item.occupied %}
                    <span class="badge badge-success">æœ‰ç‰©å“</span>
                    {% else %}
                    <span class="badge badge-warning">ç©ºçš„</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="flex: 1; background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="width: {{ item.fill_percent }}%; background: {% if item.fill_percent > 75 %}#28a745{% elif item.fill_percent > 50 %}#ffc107{% elif item.fill_percent > 25 %}#17a2b8{% else %}#dc3545{% endif %}; height: 100%;"></div>
                        </div>
                        <span style="min-width: 50px;">{{ "%.1f"|format(item.fill_percent) }}%</span>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">
    <p style="font-size: 1.2em;">ğŸ“ˆ æ²’æœ‰æ‰¾åˆ°æ„Ÿæ¸¬å™¨æ•¸æ“š</p>
    <p>è«‹æª¢æŸ¥ç¯©é¸æ¢ä»¶æˆ–ç­‰å¾… ESP32 ç™¼é€æ•¸æ“š</p>
</div>
{% endif %}
{% endblock %}

{% block extra_script %}
<script>
    // è‡ªå‹•é‡æ–°æ•´ç†ï¼ˆæ¯ 10 ç§’ï¼‰
    let autoRefresh = setInterval(function() {
        location.reload();
    }, 10000);
    
    // ç•¶ç”¨æˆ¶æ“ä½œè¡¨å–®æ™‚åœæ­¢è‡ªå‹•é‡æ–°æ•´ç†
    document.querySelectorAll('select, button').forEach(element => {
        element.addEventListener('click', function() {
            clearInterval(autoRefresh);
        });
    });
</script>
{% endblock %}

