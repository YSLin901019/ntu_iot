{% extends "base.html" %}

{% block title %}æ„Ÿæ¸¬å™¨æ•¸æ“š - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>ğŸ“ˆ æ„Ÿæ¸¬å™¨æ•¸æ“šç›£æ§</h2>
    <div style="display: flex; gap: 10px; align-items: center;">
        <span id="refresh-status" style="color: #28a745;">â— å¯¦æ™‚æ›´æ–°ä¸­</span>
        <button onclick="toggleAutoRefresh()" id="refresh-toggle" class="btn btn-success">
            â¸ï¸ æš«åœæ›´æ–°
        </button>
        <button onclick="manualRefresh()" class="btn btn-primary">
            ğŸ”„ ç«‹å³åˆ·æ–°
        </button>
        <button onclick="showDeleteOptions()" class="btn btn-danger" style="background: #dc3545;">
            ğŸ—‘ï¸ æ¸…ç†æ•¸æ“š
        </button>
    </div>
</div>

<!-- åˆªé™¤æ•¸æ“šé¸é …ï¼ˆéš±è—çš„å½ˆå‡ºæ¡†ï¼‰-->
<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; box-shadow: 0 8px 16px rgba(0,0,0,0.2);">
        <h3 style="margin: 0 0 20px 0; color: #2d3748;">ğŸ—‘ï¸ æ¸…ç†æ„Ÿæ¸¬å™¨æ­·å²æ•¸æ“š</h3>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
            <strong style="color: #856404;">âš ï¸ æ³¨æ„</strong>
            <p style="color: #856404; margin: 5px 0 0 0; font-size: 14px;">
                æ­¤æ“ä½œåªæœƒåˆªé™¤æ„Ÿæ¸¬å™¨çš„æ­·å²æ•¸æ“šè¨˜éŒ„ï¼Œ<strong>ä¸æœƒå½±éŸ¿</strong>è¨­å‚™é…ç½®ã€è²¨æ¶è¨­å®šã€å•†å“è³‡è¨Šç­‰ã€‚
            </p>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px;">
            <button onclick="deleteData('time', 7)" class="btn" style="background: #17a2b8; color: white; padding: 12px; text-align: left;">
                ğŸ—“ï¸ åˆªé™¤ 7 å¤©å‰çš„æ•¸æ“š
            </button>
            <button onclick="deleteData('time', 30)" class="btn" style="background: #17a2b8; color: white; padding: 12px; text-align: left;">
                ğŸ—“ï¸ åˆªé™¤ 30 å¤©å‰çš„æ•¸æ“š
            </button>
            <button onclick="deleteData('time', 90)" class="btn" style="background: #17a2b8; color: white; padding: 12px; text-align: left;">
                ğŸ—“ï¸ åˆªé™¤ 90 å¤©å‰çš„æ•¸æ“š
            </button>
            <button onclick="deleteData('all')" class="btn btn-danger" style="padding: 12px; text-align: left;">
                âš ï¸ åˆªé™¤æ‰€æœ‰æ­·å²æ•¸æ“š
            </button>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="hideDeleteOptions()" class="btn" style="background: #6c757d; color: white; padding: 10px 20px;">
                å–æ¶ˆ
            </button>
        </div>
    </div>
</div>

<!-- çµ±è¨ˆå¡ç‰‡ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 0.9em; opacity: 0.9;">ç¸½æ•¸æ“šç­†æ•¸</div>
        <div id="stat-total" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 0.9em; opacity: 0.9;">åœ¨ç·šè¨­å‚™</div>
        <div id="stat-devices" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 0.9em; opacity: 0.9;">æ´»èºè²¨æ¶</div>
        <div id="stat-shelves" style="font-size: 2em; font-weight: bold; margin-top: 5px;">-</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="font-size: 0.9em; opacity: 0.9;">æœ€å¾Œæ›´æ–°</div>
        <div id="stat-last-update" style="font-size: 1.2em; font-weight: bold; margin-top: 5px;">-</div>
    </div>
</div>

<!-- ç¯©é¸è¡¨å–® -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
    <h4 style="margin-bottom: 15px;">ğŸ” ç¯©é¸æ¢ä»¶</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div class="form-group">
            <label for="filter-location">å€åŸŸ</label>
            <select id="filter-location" onchange="applyFilters()">
                <option value="">-- æ‰€æœ‰å€åŸŸ --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="filter-device">è¨­å‚™</label>
            <select id="filter-device" onchange="applyFilters()">
                <option value="">-- æ‰€æœ‰è¨­å‚™ --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="filter-shelf">è²¨æ¶ ID</label>
            <select id="filter-shelf" onchange="applyFilters()">
                <option value="">-- æ‰€æœ‰è²¨æ¶ --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="filter-limit">é¡¯ç¤ºç­†æ•¸</label>
            <select id="filter-limit" onchange="applyFilters()">
                <option value="20">20 ç­†</option>
                <option value="50" selected>50 ç­†</option>
                <option value="100">100 ç­†</option>
                <option value="200">200 ç­†</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="filter-occupied">å ç”¨ç‹€æ…‹</label>
            <select id="filter-occupied" onchange="applyFilters()">
                <option value="">-- å…¨éƒ¨ --</option>
                <option value="1">æœ‰ç‰©å“</option>
                <option value="0">ç©ºçš„</option>
            </select>
        </div>
    </div>
</div>

<!-- æ•¸æ“šè¡¨æ ¼ -->
<div id="data-container">
    <div style="text-align: center; padding: 40px; color: #999;">
        <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p>æ­£åœ¨è¼‰å…¥æ•¸æ“š...</p>
    </div>
</div>

{% endblock %}

{% block extra_script %}
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .data-row {
        transition: background-color 0.3s;
    }
    
    .data-row:hover {
        background-color: #f8f9fa;
    }
    
    .data-row.new-data {
        animation: highlight 2s;
    }
    
    @keyframes highlight {
        0% { background-color: #d4edda; }
        100% { background-color: transparent; }
    }
</style>

<script>
let autoRefreshInterval = null;
let isRefreshing = true;
let lastDataIds = new Set();

// è¼‰å…¥æ•¸æ“š
async function loadData() {
    try {
        // æ§‹å»ºæŸ¥è©¢åƒæ•¸
        const params = new URLSearchParams({
            location: document.getElementById('filter-location').value,
            device_id: document.getElementById('filter-device').value,
            shelf_id: document.getElementById('filter-shelf').value,
            limit: document.getElementById('filter-limit').value,
            occupied: document.getElementById('filter-occupied').value
        });
        
        const response = await fetch(`/api/sensor_data?${params}`);
        const result = await response.json();
        
        if (result.success) {
            updateStatistics(result.stats);
            updateDataTable(result.data);
            updateFilterOptions(result.filters);
        } else {
            console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', result.error);
        }
    } catch (error) {
        console.error('è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    }
}

// æ›´æ–°çµ±è¨ˆè³‡è¨Š
function updateStatistics(stats) {
    document.getElementById('stat-total').textContent = stats.total_count || 0;
    document.getElementById('stat-devices').textContent = stats.device_count || 0;
    document.getElementById('stat-shelves').textContent = stats.shelf_count || 0;
    
    if (stats.last_update) {
        const updateTime = new Date(stats.last_update);
        const now = new Date();
        const diffSeconds = Math.floor((now - updateTime) / 1000);
        
        let timeText;
        if (diffSeconds < 60) {
            timeText = `${diffSeconds} ç§’å‰`;
        } else if (diffSeconds < 3600) {
            timeText = `${Math.floor(diffSeconds / 60)} åˆ†é˜å‰`;
        } else {
            timeText = updateTime.toLocaleTimeString('zh-TW');
        }
        
        document.getElementById('stat-last-update').textContent = timeText;
    }
}

// æ›´æ–°æ•¸æ“šè¡¨æ ¼
function updateDataTable(data) {
    const container = document.getElementById('data-container');
    
    if (!data || data.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p style="font-size: 1.2em;">ğŸ“ˆ æ²’æœ‰æ‰¾åˆ°æ„Ÿæ¸¬å™¨æ•¸æ“š</p>
                <p>è«‹æª¢æŸ¥ç¯©é¸æ¢ä»¶æˆ–ç­‰å¾… ESP32 ç™¼é€æ•¸æ“š</p>
            </div>
        `;
        return;
    }
    
    // æª¢æ¸¬æ–°æ•¸æ“š
    const currentDataIds = new Set(data.map(item => item.id));
    const newIds = new Set([...currentDataIds].filter(id => !lastDataIds.has(id)));
    lastDataIds = currentDataIds;
    
    let html = `
        <p style="color: #6c757d; margin-bottom: 10px;">
            é¡¯ç¤º ${data.length} ç­†è¨˜éŒ„
        </p>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>æ™‚é–“</th>
                        <th>è¨­å‚™</th>
                        <th>å€åŸŸ</th>
                        <th>è²¨æ¶</th>
                        <th>å•†å“</th>
                        <th>æ•¸é‡</th>
                        <th>è·é›¢ (cm)</th>
                        <th>å ç”¨ç‹€æ…‹</th>
                        <th>å¡«å……ç‡</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.forEach(item => {
        const isNew = newIds.has(item.id);
        const rowClass = isNew ? 'data-row new-data' : 'data-row';
        
        const occupiedBadge = item.occupied 
            ? '<span class="badge badge-success">âœ… æœ‰ç‰©å“</span>' 
            : '<span class="badge badge-warning">â­• ç©ºçš„</span>';
        
        const fillPercent = item.fill_percent || 0;
        let fillColor;
        if (fillPercent > 75) fillColor = '#28a745';
        else if (fillPercent > 50) fillColor = '#ffc107';
        else if (fillPercent > 25) fillColor = '#17a2b8';
        else fillColor = '#dc3545';
        
        const productInfo = item.product_name || '<span style="color: #999;">æœªé…ç½®</span>';
        const locationInfo = item.device_location || '<span style="color: #999;">æœªåˆ†é…</span>';
        const stockQuantity = item.stock_quantity || 0;
        
        html += `
            <tr class="${rowClass}">
                <td>${formatTime(item.timestamp)}</td>
                <td><small>${item.device_id}</small></td>
                <td><span style="color: #667eea; font-weight: bold;">${locationInfo}</span></td>
                <td><strong>${item.shelf_id}</strong></td>
                <td>${productInfo}</td>
                <td style="text-align: center;"><strong style="color: #667eea;">${stockQuantity}</strong></td>
                <td style="text-align: right;">${item.distance_cm.toFixed(1)}</td>
                <td>${occupiedBadge}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="flex: 1; background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="width: ${fillPercent}%; background: ${fillColor}; height: 100%; transition: width 0.3s;"></div>
                        </div>
                        <span style="min-width: 50px;">${fillPercent.toFixed(1)}%</span>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// æ›´æ–°ç¯©é¸é¸é …
function updateFilterOptions(filters) {
    // æ›´æ–°å€åŸŸåˆ—è¡¨
    const locationSelect = document.getElementById('filter-location');
    const currentLocation = locationSelect.value;
    locationSelect.innerHTML = '<option value="">-- æ‰€æœ‰å€åŸŸ --</option>';
    if (filters.locations) {
        filters.locations.forEach(location => {
            if (location) {  // éæ¿¾ç©ºå€¼
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                if (location === currentLocation) option.selected = true;
                locationSelect.appendChild(option);
            }
        });
    }
    
    // æ›´æ–°è¨­å‚™åˆ—è¡¨
    const deviceSelect = document.getElementById('filter-device');
    const currentDevice = deviceSelect.value;
    deviceSelect.innerHTML = '<option value="">-- æ‰€æœ‰è¨­å‚™ --</option>';
    filters.devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device;
        option.textContent = device;
        if (device === currentDevice) option.selected = true;
        deviceSelect.appendChild(option);
    });
    
    // æ›´æ–°è²¨æ¶åˆ—è¡¨
    const shelfSelect = document.getElementById('filter-shelf');
    const currentShelf = shelfSelect.value;
    shelfSelect.innerHTML = '<option value="">-- æ‰€æœ‰è²¨æ¶ --</option>';
    filters.shelves.forEach(shelf => {
        const option = document.createElement('option');
        option.value = shelf;
        option.textContent = shelf;
        if (shelf === currentShelf) option.selected = true;
        shelfSelect.appendChild(option);
    });
}

// æ ¼å¼åŒ–æ™‚é–“
function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-TW', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// æ‡‰ç”¨ç¯©é¸
function applyFilters() {
    loadData();
}

// æ‰‹å‹•åˆ·æ–°
function manualRefresh() {
    loadData();
}

// åˆ‡æ›è‡ªå‹•æ›´æ–°
function toggleAutoRefresh() {
    isRefreshing = !isRefreshing;
    const toggleBtn = document.getElementById('refresh-toggle');
    const status = document.getElementById('refresh-status');
    
    if (isRefreshing) {
        toggleBtn.innerHTML = 'â¸ï¸ æš«åœæ›´æ–°';
        toggleBtn.className = 'btn btn-success';
        status.innerHTML = 'â— å¯¦æ™‚æ›´æ–°ä¸­';
        status.style.color = '#28a745';
        startAutoRefresh();
    } else {
        toggleBtn.innerHTML = 'â–¶ï¸ æ¢å¾©æ›´æ–°';
        toggleBtn.className = 'btn btn-warning';
        status.innerHTML = 'â¸ï¸ å·²æš«åœ';
        status.style.color = '#ffc107';
        stopAutoRefresh();
    }
}

// é¡¯ç¤ºåˆªé™¤é¸é …
function showDeleteOptions() {
    const modal = document.getElementById('delete-modal');
    modal.style.display = 'flex';
}

// éš±è—åˆªé™¤é¸é …
function hideDeleteOptions() {
    const modal = document.getElementById('delete-modal');
    modal.style.display = 'none';
}

// åˆªé™¤æ•¸æ“š
async function deleteData(type, days = null) {
    let confirmMsg = '';
    
    if (type === 'all') {
        confirmMsg = 'ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ„Ÿæ¸¬å™¨æ­·å²æ•¸æ“šå—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\nï¼ˆä¸æœƒå½±éŸ¿è¨­å‚™é…ç½®å’Œè²¨æ¶è¨­å®šï¼‰';
    } else if (type === 'time') {
        confirmMsg = `ç¢ºå®šè¦åˆªé™¤ ${days} å¤©å‰çš„æ•¸æ“šå—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
    }
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const requestData = { type };
        if (type === 'time') {
            requestData.days = days;
        }
        
        const response = await fetch('/api/sensor_data/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`âœ… ${result.message}\n\nå·²åˆªé™¤ ${result.deleted_count} ç­†æ•¸æ“š`);
            hideDeleteOptions();
            loadData(); // é‡æ–°è¼‰å…¥æ•¸æ“š
        } else {
            alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + (result.error || result.message));
        }
    } catch (error) {
        console.error('åˆªé™¤æ•¸æ“šå¤±æ•—:', error);
        alert('âŒ åˆªé™¤å¤±æ•—ï¼š' + error.message);
    }
}

// é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
document.addEventListener('click', function(event) {
    const modal = document.getElementById('delete-modal');
    if (event.target === modal) {
        hideDeleteOptions();
    }
});

// ESC éµé—œé–‰æ¨¡æ…‹æ¡†
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        hideDeleteOptions();
    }
});

// å•Ÿå‹•è‡ªå‹•æ›´æ–°
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    autoRefreshInterval = setInterval(loadData, 3000); // æ¯ 3 ç§’æ›´æ–°
}

// åœæ­¢è‡ªå‹•æ›´æ–°
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
    loadData();
    startAutoRefresh();
});

// é é¢éš±è—æ™‚åœæ­¢æ›´æ–°ï¼Œé¡¯ç¤ºæ™‚æ¢å¾©
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else if (isRefreshing) {
        startAutoRefresh();
        loadData();
    }
});
</script>
{% endblock %}
