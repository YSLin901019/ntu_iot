{% extends "base.html" %}

{% block title %}è¨­å‚™ç®¡ç† - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>ğŸ“± è¨­å‚™ç®¡ç†</h2>
    <div style="display: flex; gap: 10px;">
        <button onclick="checkAllHeartbeats()" class="btn btn-success" id="heartbeat-btn">
            â¤ï¸ æª¢æŸ¥æ‰€æœ‰è¨­å‚™ç‹€æ…‹
        </button>
        <a href="{{ url_for('add_device') }}" class="btn btn-primary">â• æ–°å¢è¨­å‚™</a>
    </div>
</div>

<div id="heartbeat-status" style="display: none; background: #d1ecf1; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div class="spinner" style="width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #17a2b8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span id="heartbeat-status-text">æ­£åœ¨æª¢æŸ¥è¨­å‚™ç‹€æ…‹...</span>
    </div>
</div>

<!-- æœªåˆ†é…å€åŸŸçš„è¨­å‚™æç¤º -->
<div id="unassigned-alert" style="display: none; background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; border-radius: 5px; margin-bottom: 20px;">
    <strong style="color: #856404;">âš ï¸ æœ‰è¨­å‚™å°šæœªæŒ‡å®šå€åŸŸ</strong>
    <p style="color: #856404; margin: 5px 0;">ä»¥ä¸‹è¨­å‚™å·²é€£ç·šä½†å°šæœªæŒ‡å®šè² è²¬å€åŸŸï¼š</p>
    <div id="unassigned-list" style="margin-top: 10px;"></div>
</div>

{% if devices %}
<table>
    <thead>
        <tr>
            <th>è¨­å‚™ ID</th>
            <th>è¨­å‚™åç¨±</th>
            <th>è² è²¬å€åŸŸ</th>
            <th>ç‹€æ…‹</th>
            <th>è²¨æ¶æ•¸é‡</th>
            <th>æœ€å¾Œä¸Šç·šæ™‚é–“</th>
            <th>æ“ä½œ</th>
        </tr>
    </thead>
    <tbody>
        {% for device in devices %}
        <tr>
            <td><strong>{{ device.device_id }}</strong></td>
            <td>{{ device.device_name }}</td>
            <td>
                {% if device.location %}
                <span class="badge badge-info">{{ device.location }}</span>
                {% else %}
                <span class="badge" style="background: #e9ecef; color: #6c757d;">æœªæŒ‡å®šå€åŸŸ</span>
                {% endif %}
            </td>
            <td>
                {% if device.status == 'online' %}
                <span class="badge badge-success">åœ¨ç·š</span>
                {% else %}
                <span class="badge badge-danger">é›¢ç·š</span>
                {% endif %}
            </td>
            <td>{{ device.shelf_count }}</td>
            <td>{{ device.last_seen or 'N/A' }}</td>
            <td>
                <div class="action-buttons">
                    <button onclick="checkSingleHeartbeat('{{ device.device_id }}')" 
                            class="btn btn-success" style="padding: 5px 15px;" title="æª¢æŸ¥è¨­å‚™ç‹€æ…‹">
                        â¤ï¸
                    </button>
                    <a href="{{ url_for('edit_device', device_id=device.device_id) }}" 
                       class="btn btn-primary" style="padding: 5px 15px;">ç·¨è¼¯å€åŸŸ</a>
                    <button onclick="confirmDelete('è¨­å‚™', '{{ device.device_id }}', '/api/devices/{{ device.device_id }}')" 
                            class="btn btn-danger" style="padding: 5px 15px;">åˆªé™¤</button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <p style="font-size: 1.2em;">ğŸ“± å°šç„¡è¨­å‚™è¨˜éŒ„</p>
    <p>è«‹é»æ“Šã€Œæ–°å¢è¨­å‚™ã€æŒ‰éˆ•ä¾†æ–°å¢ç¬¬ä¸€å€‹è¨­å‚™</p>
</div>
{% endif %}
{% endblock %}

{% block extra_script %}
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    // æª¢æŸ¥æ‰€æœ‰è¨­å‚™å¿ƒè·³
    async function checkAllHeartbeats() {
        const btn = document.getElementById('heartbeat-btn');
        const statusDiv = document.getElementById('heartbeat-status');
        const statusText = document.getElementById('heartbeat-status-text');
        
        btn.disabled = true;
        statusDiv.style.display = 'block';
        statusText.textContent = 'æ­£åœ¨æª¢æŸ¥æ‰€æœ‰è¨­å‚™ç‹€æ…‹...';
        
        try {
            const response = await fetch('/api/devices/heartbeat/all');
            const data = await response.json();
            
            if (data.success) {
                statusText.textContent = 'è¨­å‚™ç‹€æ…‹å·²æ›´æ–°ï¼æ­£åœ¨åˆ·æ–°é é¢...';
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('æª¢æŸ¥å¤±æ•—ï¼š' + data.error);
                statusDiv.style.display = 'none';
            }
        } catch (error) {
            alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
            statusDiv.style.display = 'none';
        } finally {
            btn.disabled = false;
        }
    }
    
    // æª¢æŸ¥å–®å€‹è¨­å‚™å¿ƒè·³
    async function checkSingleHeartbeat(deviceId) {
        try {
            const response = await fetch(`/api/devices/${deviceId}/heartbeat`);
            const data = await response.json();
            
            if (data.success) {
                if (data.online) {
                    alert(`è¨­å‚™ ${deviceId} åœ¨ç·šâœ…\næœ€å¾Œä¸Šç·šæ™‚é–“: ${data.last_seen}`);
                } else {
                    alert(`è¨­å‚™ ${deviceId} é›¢ç·šâŒ`);
                }
                location.reload();
            } else {
                alert('æª¢æŸ¥å¤±æ•—ï¼š' + data.error);
            }
        } catch (error) {
            alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error);
        }
    }
    
    // æª¢æŸ¥æœªåˆ†é…å€åŸŸçš„è¨­å‚™
    fetch('/api/devices/unassigned')
        .then(response => response.json())
        .then(data => {
            if (data.count > 0) {
                const alert = document.getElementById('unassigned-alert');
                const list = document.getElementById('unassigned-list');
                
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                data.devices.forEach(device => {
                    const statusBadge = device.status === 'online' 
                        ? '<span class="badge badge-success">åœ¨ç·š</span>' 
                        : '<span class="badge badge-danger">é›¢ç·š</span>';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 5px;">
                            <div>
                                <strong>${device.device_id}</strong> - ${device.device_name} 
                                ${statusBadge}
                            </div>
                            <a href="/devices/${device.device_id}/edit" class="btn btn-primary" style="padding: 5px 15px;">
                                æŒ‡å®šå€åŸŸ
                            </a>
                        </div>
                    `;
                });
                html += '</div>';
                
                list.innerHTML = html;
                alert.style.display = 'block';
            }
        })
        .catch(error => console.error('Error:', error));
</script>
{% endblock %}

