{% extends "base.html" %}

{% block title %}è²¨æ¶ç®¡ç† - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>ğŸ—‚ï¸ è²¨æ¶é…ç½®ç®¡ç†</h2>
    <a href="{{ url_for('add_shelf') }}" class="btn btn-primary">â• æ–°å¢è²¨æ¶</a>
</div>

<div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
    <h4>ğŸ“‹ èªªæ˜</h4>
    <ul style="margin: 10px 0; padding-left: 20px;">
        <li>é»æ“Šã€ŒæŸ¥çœ‹è²¨æ¶ã€å¯ä»¥æŸ¥è©¢ ESP32S3 è¨­å‚™ç•¶å‰çš„è²¨æ¶é…ç½®</li>
        <li>å•Ÿç”¨çš„è²¨æ¶æœƒåœ¨æ¯è¼ªæƒæä¸­å›å‚³è·é›¢æ•¸æ“š</li>
        <li>åªæœ‰å•Ÿç”¨çš„è²¨æ¶æ‰èƒ½åœ¨å•†å“ç®¡ç†ä¸­è¢«é¸æ“‡</li>
        <li>åœç”¨çš„è²¨æ¶ä¸æœƒé€²è¡Œæƒæï¼Œä¹Ÿä¸æœƒæ¶ˆè€—è³‡æº</li>
    </ul>
</div>

<!-- æŒ‰è¨­å‚™åˆ†çµ„é¡¯ç¤º -->
{% if devices %}
    {% for device in devices %}
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">
            <div>
                <h3 style="margin: 0;">
                    ğŸ“¡ {{ device.device_name or device.device_id }}
                    {% if device.status == 'online' %}
                        <span class="badge badge-success">åœ¨ç·š</span>
                    {% else %}
                        <span class="badge badge-danger">é›¢ç·š</span>
                    {% endif %}
                </h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    <strong>è¨­å‚™ ID:</strong> {{ device.device_id }} | 
                    <strong>å€åŸŸ:</strong> {{ device.location or 'æœªåˆ†é…' }}
                </p>
            </div>
            <button onclick="loadShelfConfig('{{ device.device_id }}')" class="btn btn-info">
                ğŸ”„ æŸ¥çœ‹è²¨æ¶é…ç½®
            </button>
        </div>

        <!-- è²¨æ¶åˆ—è¡¨å®¹å™¨ -->
        <div id="shelves-{{ device.device_id }}" class="shelf-list">
            <p style="color: #999; text-align: center; padding: 20px;">
                é»æ“Šã€ŒæŸ¥çœ‹è²¨æ¶é…ç½®ã€è¼‰å…¥è¨­å‚™è²¨æ¶...
            </p>
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="empty-state">
    <p style="font-size: 1.2em;">ğŸ“¡ å°šç„¡è¨­å‚™è¨˜éŒ„</p>
    <p>è«‹å…ˆåœ¨è¨­å‚™ç®¡ç†é é¢æ·»åŠ  ESP32S3 è¨­å‚™</p>
</div>
{% endif %}

<!-- è¼‰å…¥ä¸­æç¤º -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
        <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px auto;"></div>
        <p style="font-size: 1.2em; margin: 0;">æ­£åœ¨æŸ¥è©¢è¨­å‚™è²¨æ¶é…ç½®...</p>
    </div>
</div>

{% endblock %}

{% block extra_script %}
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .shelf-card {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s;
    }
    
    .shelf-card.enabled {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .shelf-card.disabled {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    .shelf-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<script>
// è¼‰å…¥è¨­å‚™çš„è²¨æ¶é…ç½®
async function loadShelfConfig(deviceId) {
    const container = document.getElementById(`shelves-${deviceId}`);
    const overlay = document.getElementById('loading-overlay');
    
    overlay.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/shelves/config/${deviceId}`);
        const data = await response.json();
        
        if (data.success && data.config) {
            const config = data.config;
            let html = '';
            
            if (config.shelves && config.shelves.length > 0) {
                html += `
                    <div style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>è²¨æ¶ç¸½æ•¸:</strong> ${config.total_count} | 
                        <strong>å·²å•Ÿç”¨:</strong> ${config.enabled_count} | 
                        <strong>å·²åœç”¨:</strong> ${config.total_count - config.enabled_count}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                `;
                
                config.shelves.forEach(shelf => {
                    const enabledClass = shelf.enabled ? 'enabled' : 'disabled';
                    const statusIcon = shelf.enabled ? 'âœ…' : 'âŒ';
                    const statusText = shelf.enabled ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨';
                    const buttonClass = shelf.enabled ? 'btn-danger' : 'btn-success';
                    const buttonText = shelf.enabled ? 'åœç”¨' : 'å•Ÿç”¨';
                    const buttonAction = shelf.enabled ? 'disableShelf' : 'enableShelf';
                    
                    html += `
                        <div class="shelf-card ${enabledClass}" id="shelf-card-${shelf.shelf_id}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h4 style="margin: 0 0 10px 0;">${statusIcon} è²¨æ¶ ${shelf.shelf_id}</h4>
                                    <p style="margin: 5px 0; color: #666;">
                                        <strong>GPIO:</strong> ${shelf.gpio}<br>
                                        <strong>ä½ç½®:</strong> ${shelf.index}<br>
                                        <strong>ç‹€æ…‹:</strong> ${statusText}
                                    </p>
                                </div>
                                <button onclick="${buttonAction}('${shelf.shelf_id}')" 
                                        class="btn ${buttonClass}" 
                                        style="padding: 8px 16px;">
                                    ${buttonText}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html = '<p style="color: #999; text-align: center; padding: 20px;">æ­¤è¨­å‚™æ²’æœ‰è²¨æ¶é…ç½®</p>';
            }
            
            container.innerHTML = html;
        } else {
            container.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">æŸ¥è©¢å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
        }
    } catch (error) {
        container.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">ç™¼ç”ŸéŒ¯èª¤: ${error.message}</p>`;
    } finally {
        overlay.style.display = 'none';
    }
}

// å•Ÿç”¨è²¨æ¶
async function enableShelf(shelfId) {
    try {
        const response = await fetch(`/api/shelves/${shelfId}/enable`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–° UI
            const card = document.getElementById(`shelf-card-${shelfId}`);
            if (card) {
                card.className = 'shelf-card enabled';
                card.querySelector('h4').innerHTML = `âœ… è²¨æ¶ ${shelfId}`;
                card.querySelector('button').className = 'btn btn-danger';
                card.querySelector('button').textContent = 'åœç”¨';
                card.querySelector('button').setAttribute('onclick', `disableShelf('${shelfId}')`);
                
                // æ›´æ–°ç‹€æ…‹æ–‡æœ¬
                const statusText = card.querySelector('p').innerHTML;
                card.querySelector('p').innerHTML = statusText.replace('å·²åœç”¨', 'å·²å•Ÿç”¨');
            }
            
            alert(`âœ… è²¨æ¶ ${shelfId} å·²å•Ÿç”¨`);
        } else {
            alert(`âŒ å•Ÿç”¨å¤±æ•—: ${data.error}`);
        }
    } catch (error) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}

// åœç”¨è²¨æ¶
async function disableShelf(shelfId) {
    if (!confirm(`ç¢ºå®šè¦åœç”¨è²¨æ¶ ${shelfId} å—ï¼Ÿ\nåœç”¨å¾Œå°‡ä¸æœƒé€²è¡Œæ„Ÿæ¸¬å™¨æƒæã€‚`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/shelves/${shelfId}/disable`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–° UI
            const card = document.getElementById(`shelf-card-${shelfId}`);
            if (card) {
                card.className = 'shelf-card disabled';
                card.querySelector('h4').innerHTML = `âŒ è²¨æ¶ ${shelfId}`;
                card.querySelector('button').className = 'btn btn-success';
                card.querySelector('button').textContent = 'å•Ÿç”¨';
                card.querySelector('button').setAttribute('onclick', `enableShelf('${shelfId}')`);
                
                // æ›´æ–°ç‹€æ…‹æ–‡æœ¬
                const statusText = card.querySelector('p').innerHTML;
                card.querySelector('p').innerHTML = statusText.replace('å·²å•Ÿç”¨', 'å·²åœç”¨');
            }
            
            alert(`âœ… è²¨æ¶ ${shelfId} å·²åœç”¨`);
        } else {
            alert(`âŒ åœç”¨å¤±æ•—: ${data.error}`);
        }
    } catch (error) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}
</script>
{% endblock %}
