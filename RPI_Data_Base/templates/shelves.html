{% extends "base.html" %}

{% block title %}è²¨æ¶ç®¡ç† - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>ğŸ—‚ï¸ è²¨æ¶é…ç½®ç®¡ç†</h2>
</div>

<div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
    <h4>ğŸ“‹ ä½¿ç”¨èªªæ˜</h4>
    <ul style="margin: 10px 0; padding-left: 20px;">
        <li>é»æ“Šã€ŒæŸ¥çœ‹è²¨æ¶ã€æŸ¥è©¢ ESP32S3 è¨­å‚™ç•¶å‰çš„è²¨æ¶é…ç½®</li>
        <li>é»æ“Šã€ŒğŸ“ æ ¡æ­£ã€æ¸¬é‡ç©ºè²¨æ¶é•·åº¦ï¼ˆå³è²¨æ¶çš„æœ€å¤§è·é›¢ï¼‰</li>
        <li>å•Ÿç”¨çš„è²¨æ¶æœƒåœ¨æ¯è¼ªæƒæä¸­å›å‚³è·é›¢æ•¸æ“š</li>
        <li><strong>åªæœ‰å·²å•Ÿç”¨çš„è²¨æ¶æ‰èƒ½é…ç½®å•†å“</strong></li>
        <li>åœç”¨çš„è²¨æ¶ä¸æœƒé€²è¡Œæƒæï¼Œä¹Ÿç„¡æ³•é…ç½®å•†å“</li>
    </ul>
</div>

<!-- æŒ‰è¨­å‚™åˆ†çµ„é¡¯ç¤º -->
{% if devices %}
    {% for device in devices %}
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">
            <div>
                <h3 style="margin: 0;">
                    ğŸ“¡ {{ device.device_name or device.device_id }}
                    {% if device.status == 'online' %}
                        <span class="badge badge-success">åœ¨ç·š</span>
                    {% else %}
                        <span class="badge badge-danger">é›¢ç·š</span>
                    {% endif %}
                </h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    <strong>è¨­å‚™ ID:</strong> {{ device.device_id }} | 
                    <strong>å€åŸŸ:</strong> {{ device.location or 'æœªåˆ†é…' }}
                </p>
            </div>
            <button onclick="loadShelfConfig('{{ device.device_id }}')" class="btn btn-info">
                ğŸ”„ æŸ¥çœ‹è²¨æ¶é…ç½®
            </button>
        </div>

        <!-- è²¨æ¶åˆ—è¡¨å®¹å™¨ -->
        <div id="shelves-{{ device.device_id }}" class="shelf-list">
            <p style="color: #999; text-align: center; padding: 20px;">
                é»æ“Šã€ŒæŸ¥çœ‹è²¨æ¶é…ç½®ã€è¼‰å…¥è¨­å‚™è²¨æ¶...
            </p>
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="empty-state">
    <p style="font-size: 1.2em;">ğŸ“¡ å°šç„¡è¨­å‚™è¨˜éŒ„</p>
    <p>è«‹å…ˆåœ¨è¨­å‚™ç®¡ç†é é¢æ·»åŠ  ESP32S3 è¨­å‚™</p>
</div>
{% endif %}

<!-- è¼‰å…¥ä¸­æç¤º -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
        <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px auto;"></div>
        <p style="font-size: 1.2em; margin: 0;">æ­£åœ¨æŸ¥è©¢è¨­å‚™è²¨æ¶é…ç½®...</p>
    </div>
</div>

{% endblock %}

{% block extra_script %}
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .shelf-card {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s;
    }
    
    .shelf-card.enabled {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .shelf-card.disabled {
        border-color: #dc3545;
        background: #f8d7da;
    }
    
    .shelf-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<script>
// è¼‰å…¥è¨­å‚™çš„è²¨æ¶é…ç½®
async function loadShelfConfig(deviceId) {
    const container = document.getElementById(`shelves-${deviceId}`);
    const overlay = document.getElementById('loading-overlay');
    
    overlay.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/shelves/config/${deviceId}`);
        const data = await response.json();
        
        if (data.success && data.config) {
            const config = data.config;
            let html = '';
            
            if (config.shelves && config.shelves.length > 0) {
                html += `
                    <div style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>è²¨æ¶ç¸½æ•¸:</strong> ${config.total_count} | 
                        <strong>å·²å•Ÿç”¨:</strong> ${config.enabled_count} | 
                        <strong>å·²åœç”¨:</strong> ${config.total_count - config.enabled_count}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                `;
                
                config.shelves.forEach(shelf => {
                    const enabledClass = shelf.enabled ? 'enabled' : 'disabled';
                    const statusIcon = shelf.enabled ? 'âœ…' : 'âŒ';
                    const statusText = shelf.enabled ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨';
                    
                    // è²¨æ¶é•·åº¦
                    const shelfLength = shelf.shelf_length > 0 ? `${shelf.shelf_length.toFixed(1)} cm` : 'æœªæ ¡æ­£';
                    const lengthColor = shelf.shelf_length > 0 ? '#28a745' : '#ffc107';
                    
                    html += `
                        <div class="shelf-card ${enabledClass}" id="shelf-card-${shelf.shelf_id}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 10px 0;">${statusIcon} è²¨æ¶ ${shelf.shelf_id}</h4>
                                    <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                                        <strong>GPIO:</strong> ${shelf.gpio}<br>
                                        <strong>ä½ç½®:</strong> ${shelf.index}<br>
                                        <strong>ç‹€æ…‹:</strong> ${statusText}<br>
                                        <strong>è²¨æ¶é•·åº¦:</strong> <span style="color: ${lengthColor}; font-weight: bold;">${shelfLength}</span>
                                    </p>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;
                    
                    // æ ¡æ­£æŒ‰éˆ•ï¼ˆç¸½æ˜¯é¡¯ç¤ºï¼‰
                    html += `
                        <button onclick="calibrateShelf('${deviceId}', '${shelf.shelf_id}')" 
                                class="btn btn-warning" 
                                style="padding: 8px 16px;">
                            ğŸ“ æ ¡æ­£
                        </button>
                    `;
                    
                    // å•Ÿç”¨/åœç”¨æŒ‰éˆ•
                    if (shelf.enabled) {
                        html += `
                            <button onclick="disableShelf('${shelf.shelf_id}')" 
                                    class="btn btn-danger" 
                                    style="padding: 8px 16px;">
                                åœç”¨
                            </button>
                        `;
                    } else {
                        html += `
                            <button onclick="enableShelf('${shelf.shelf_id}')" 
                                    class="btn btn-success" 
                                    style="padding: 8px 16px;">
                                å•Ÿç”¨
                            </button>
                        `;
                    }
                    
                    // é…ç½®å•†å“æŒ‰éˆ•ï¼ˆæ‰€æœ‰è²¨æ¶éƒ½é¡¯ç¤ºï¼Œä½†æœƒåœ¨é»æ“Šæ™‚æª¢æŸ¥ï¼‰
                    html += `
                        <button onclick="configureProduct('${deviceId}', '${shelf.shelf_id}', ${shelf.enabled})" 
                                class="btn btn-primary" 
                                style="padding: 8px 16px;">
                            ğŸ“¦ é…ç½®å•†å“
                        </button>
                    `;
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html = '<p style="color: #999; text-align: center; padding: 20px;">æ­¤è¨­å‚™æ²’æœ‰è²¨æ¶é…ç½®</p>';
            }
            
            container.innerHTML = html;
        } else {
            container.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">æŸ¥è©¢å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
        }
    } catch (error) {
        container.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">ç™¼ç”ŸéŒ¯èª¤: ${error.message}</p>`;
    } finally {
        overlay.style.display = 'none';
    }
}

// é…ç½®å•†å“
function configureProduct(deviceId, shelfId, isEnabled) {
    // æª¢æŸ¥è²¨æ¶æ˜¯å¦å·²å•Ÿç”¨
    if (!isEnabled) {
        alert('âš ï¸ ç„¡æ³•é…ç½®å•†å“\n\næ­¤è²¨æ¶å°šæœªå•Ÿç”¨ï¼Œç„¡æ³•é…ç½®å•†å“ã€‚\nè«‹å…ˆé»æ“Šã€Œå•Ÿç”¨ã€æŒ‰éˆ•å•Ÿç”¨æ­¤è²¨æ¶ã€‚');
        return;
    }
    
    // è·³è½‰åˆ°é…ç½®å•†å“é é¢
    window.location.href = `/shelves/${shelfId}/configure`;
}

// å•Ÿç”¨è²¨æ¶
async function enableShelf(shelfId) {
    try {
        const response = await fetch(`/api/shelves/${shelfId}/enable`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–° UI
            const card = document.getElementById(`shelf-card-${shelfId}`);
            if (card) {
                card.className = 'shelf-card enabled';
                card.querySelector('h4').innerHTML = `âœ… è²¨æ¶ ${shelfId}`;
                
                // æ‰¾åˆ°æ‰€æœ‰æŒ‰éˆ•
                const buttons = card.querySelectorAll('button');
                // ç¬¬äºŒå€‹æŒ‰éˆ•æ˜¯å•Ÿç”¨/åœç”¨æŒ‰éˆ•ï¼ˆç¬¬ä¸€å€‹æ˜¯æ ¡æ­£ï¼Œç¬¬ä¸‰å€‹æ˜¯é…ç½®å•†å“ï¼‰
                if (buttons[1]) {
                    buttons[1].className = 'btn btn-danger';
                    buttons[1].textContent = 'åœç”¨';
                    buttons[1].setAttribute('onclick', `disableShelf('${shelfId}')`);
                }
                
                // æ›´æ–°ç‹€æ…‹æ–‡æœ¬
                const statusText = card.querySelector('p').innerHTML;
                card.querySelector('p').innerHTML = statusText.replace('å·²åœç”¨', 'å·²å•Ÿç”¨');
            }
            
            alert(`âœ… è²¨æ¶ ${shelfId} å·²å•Ÿç”¨`);
        } else {
            alert(`âŒ å•Ÿç”¨å¤±æ•—: ${data.error}`);
        }
    } catch (error) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}

// åœç”¨è²¨æ¶
async function disableShelf(shelfId) {
    if (!confirm(`ç¢ºå®šè¦åœç”¨è²¨æ¶ ${shelfId} å—ï¼Ÿ\nåœç”¨å¾Œå°‡ä¸æœƒé€²è¡Œæ„Ÿæ¸¬å™¨æƒæã€‚`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/shelves/${shelfId}/disable`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–° UI
            const card = document.getElementById(`shelf-card-${shelfId}`);
            if (card) {
                card.className = 'shelf-card disabled';
                card.querySelector('h4').innerHTML = `âŒ è²¨æ¶ ${shelfId}`;
                
                // æ‰¾åˆ°æ‰€æœ‰æŒ‰éˆ•
                const buttons = card.querySelectorAll('button');
                // ç¬¬äºŒå€‹æŒ‰éˆ•æ˜¯å•Ÿç”¨/åœç”¨æŒ‰éˆ•ï¼ˆç¬¬ä¸€å€‹æ˜¯æ ¡æ­£ï¼Œç¬¬ä¸‰å€‹æ˜¯é…ç½®å•†å“ï¼‰
                if (buttons[1]) {
                    buttons[1].className = 'btn btn-success';
                    buttons[1].textContent = 'å•Ÿç”¨';
                    buttons[1].setAttribute('onclick', `enableShelf('${shelfId}')`);
                }
                
                // æ›´æ–°ç‹€æ…‹æ–‡æœ¬
                const statusText = card.querySelector('p').innerHTML;
                card.querySelector('p').innerHTML = statusText.replace('å·²å•Ÿç”¨', 'å·²åœç”¨');
            }
            
            alert(`âœ… è²¨æ¶ ${shelfId} å·²åœç”¨`);
        } else {
            alert(`âŒ åœç”¨å¤±æ•—: ${data.error}`);
        }
    } catch (error) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    }
}

// æ ¡æ­£è²¨æ¶
async function calibrateShelf(deviceId, shelfId) {
    if (!confirm(`ğŸ“ é–‹å§‹æ ¡æ­£è²¨æ¶ ${shelfId}\n\nâš ï¸ è«‹ç¢ºä¿ï¼š\n1. è²¨æ¶ä¸Šæ²’æœ‰ä»»ä½•ç‰©å“\n2. æ„Ÿæ¸¬å™¨æ­£å¸¸å·¥ä½œ\n3. ç­‰å¾…ç´„ 3-5 ç§’å®Œæˆæ ¡æ­£\n\nğŸ“Š æ ¡æ­£èªªæ˜ï¼š\nâ€¢ æ¸¬é‡ç©ºè²¨æ¶çš„é•·åº¦\nâ€¢ æ­¤é•·åº¦å°‡ä½œç‚ºè²¨æ¶çš„æœ€å¤§è·é›¢ (max_distance)\nâ€¢ ç”¨æ–¼è¨ˆç®—å•†å“æ•¸é‡å’Œå¡«å……ç‡\n\nç¢ºå®šè¦é–‹å§‹å—ï¼Ÿ`)) {
        return;
    }
    
    const overlay = document.getElementById('loading-overlay');
    overlay.querySelector('p').textContent = `æ­£åœ¨æ ¡æ­£è²¨æ¶ ${shelfId}ï¼Œè«‹ç¨å€™...`;
    overlay.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/shelves/${shelfId}/calibrate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                device_id: deviceId,
                shelf_id: shelfId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`âœ… æ ¡æ­£æˆåŠŸï¼\n\nè²¨æ¶ ${shelfId} é•·åº¦: ${data.shelf_length.toFixed(2)} cm`);
            
            // é‡æ–°è¼‰å…¥è¨­å‚™é…ç½®ä»¥æ›´æ–°é¡¯ç¤º
            await loadShelfConfig(deviceId);
        } else {
            alert(`âŒ æ ¡æ­£å¤±æ•—\n\nåŸå› : ${data.error || 'æœªçŸ¥éŒ¯èª¤'}\n\nè«‹æª¢æŸ¥ï¼š\n- æ„Ÿæ¸¬å™¨æ˜¯å¦é€£æ¥æ­£å¸¸\n- è²¨æ¶ä¸Šæ˜¯å¦æ¸…ç©º\n- ESP32 æ˜¯å¦åœ¨ç·š`);
        }
    } catch (error) {
        alert(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
    } finally {
        overlay.querySelector('p').textContent = 'æ­£åœ¨æŸ¥è©¢è¨­å‚™è²¨æ¶é…ç½®...';
        overlay.style.display = 'none';
    }
}
</script>
{% endblock %}
