{% extends "base.html" %}

{% block title %}æ–°å¢è¨­å‚™ - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<h2>â• æ–°å¢ ESP32 è¨­å‚™</h2>

<div style="background: #e7f3ff; padding: 20px; border-left: 4px solid #667eea; border-radius: 5px; margin: 20px 0;">
    <h4 style="color: #667eea; margin-bottom: 10px;">ğŸ’¡ å…©ç¨®æ–°å¢æ–¹å¼</h4>
    <ol style="color: #495057; line-height: 1.8;">
        <li><strong>è‡ªå‹•æ¢æ¸¬</strong>ï¼šé»æ“Šã€Œæƒæå¯ç”¨è¨­å‚™ã€æŒ‰éˆ•ï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼ç¾æ‰€æœ‰åœ¨ç·šçš„ ESP32S3</li>
        <li><strong>æ‰‹å‹•è¼¸å…¥</strong>ï¼šå¦‚æœæ¢æ¸¬å¤±æ•—ï¼Œå¯ä»¥æ‰‹å‹•å¡«å¯«è¨­å‚™è³‡è¨Š</li>
    </ol>
</div>

<!-- è¨­å‚™æ¢æ¸¬å€åŸŸ -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="color: #495057; margin: 0;">ğŸ” è‡ªå‹•æ¢æ¸¬è¨­å‚™</h3>
        <button onclick="scanDevices()" id="scan-btn" class="btn btn-primary">
            <span id="scan-text">ğŸ“¡ æƒæå¯ç”¨è¨­å‚™</span>
        </button>
    </div>
    
    <div id="scan-status" style="display: none; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="spinner" style="width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span id="scan-status-text">æ­£åœ¨æƒæè¨­å‚™...</span>
        </div>
    </div>
    
    <div id="discovered-devices" style="display: none;">
        <h4 style="color: #495057; margin-bottom: 10px;">ç™¼ç¾çš„è¨­å‚™ï¼š</h4>
        <div id="devices-list"></div>
    </div>
    
    <div id="no-devices" style="display: none; padding: 15px; background: #fff3cd; border-radius: 5px;">
        <strong style="color: #856404;">âš ï¸ æœªç™¼ç¾è¨­å‚™</strong>
        <p style="color: #856404; margin: 5px 0;">è«‹ç¢ºèªï¼š</p>
        <ul style="color: #856404; padding-left: 20px;">
            <li>ESP32S3 å·²é–‹æ©Ÿä¸¦é€£æ¥åˆ°ç¶²è·¯</li>
            <li>ESP32S3 å·²é€£æ¥åˆ° MQTT Broker</li>
            <li>ESP32S3 ç¨‹å¼å·²æ­£ç¢ºè¨­å®š</li>
        </ul>
    </div>
</div>

<!-- æ‰‹å‹•æ–°å¢è¡¨å–® -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
    <h3 style="color: #495057; margin-bottom: 15px;">âœï¸ æ‰‹å‹•è¼¸å…¥è¨­å‚™è³‡è¨Š</h3>
    
    <form method="POST" style="max-width: 600px;">
        <input type="hidden" id="from_discovery" name="from_discovery" value="false">
        
        <div class="form-group">
            <label for="device_id">è¨­å‚™ ID *</label>
            <input type="text" id="device_id" name="device_id" required 
                   placeholder="ä¾‹å¦‚: ESP32_001">
        </div>
        
        <div class="form-group">
            <label for="device_name">è¨­å‚™åç¨± *</label>
            <input type="text" id="device_name" name="device_name" required 
                   placeholder="ä¾‹å¦‚: ESP32 è¨­å‚™ 1">
        </div>
        
        <div class="form-group">
            <label for="location">è¨­å‚™ä½ç½®</label>
            <input type="text" id="location" name="location" 
                   placeholder="ä¾‹å¦‚: å€‰åº« A å€">
        </div>
        
        <div class="action-buttons">
            <button type="submit" class="btn btn-primary">âœ“ æ–°å¢è¨­å‚™</button>
            <a href="{{ url_for('devices') }}" class="btn" style="background: #6c757d; color: white;">å–æ¶ˆ</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_style %}
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .device-card {
        background: white;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        border: 2px solid #e9ecef;
        transition: all 0.3s;
    }
    
    .device-card:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    .device-card.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }
</style>
{% endblock %}

{% block extra_script %}
<script>
    let discoveredDevices = [];
    
    async function scanDevices() {
        const scanBtn = document.getElementById('scan-btn');
        const scanStatus = document.getElementById('scan-status');
        const discoveredDiv = document.getElementById('discovered-devices');
        const noDevicesDiv = document.getElementById('no-devices');
        const devicesList = document.getElementById('devices-list');
        
        // éš±è—ä¹‹å‰çš„çµæœ
        discoveredDiv.style.display = 'none';
        noDevicesDiv.style.display = 'none';
        devicesList.innerHTML = '';
        
        // é¡¯ç¤ºæƒæç‹€æ…‹
        scanBtn.disabled = true;
        scanStatus.style.display = 'block';
        document.getElementById('scan-text').textContent = 'æƒæä¸­...';
        
        try {
            const response = await fetch('/api/devices/discover');
            const data = await response.json();
            
            if (data.success && data.count > 0) {
                discoveredDevices = data.devices;
                displayDevices(data.devices);
                discoveredDiv.style.display = 'block';
            } else {
                noDevicesDiv.style.display = 'block';
            }
        } catch (error) {
            alert('è¨­å‚™æ¢æ¸¬å¤±æ•—ï¼š' + error);
            noDevicesDiv.style.display = 'block';
        } finally {
            scanBtn.disabled = false;
            scanStatus.style.display = 'none';
            document.getElementById('scan-text').textContent = 'ğŸ“¡ é‡æ–°æƒæ';
        }
    }
    
    function displayDevices(devices) {
        const devicesList = document.getElementById('devices-list');
        
        devices.forEach((device, index) => {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.onclick = () => selectDevice(index, card);
            
            const uptime = formatUptime(device.uptime_ms);
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <strong style="font-size: 1.1em;">${device.device_id}</strong>
                            <span class="badge badge-success">åœ¨ç·š</span>
                        </div>
                        <div style="color: #6c757d; font-size: 0.9em; line-height: 1.6;">
                            <div>ğŸ“± è¨­å‚™åç¨±: ${device.device_name}</div>
                            <div>ğŸ—‚ï¸ è²¨æ¶æ•¸é‡: ${device.shelf_count} å€‹</div>
                            <div>ğŸ“Š WiFi ä¿¡è™Ÿ: ${device.wifi_signal} dBm</div>
                            <div>â±ï¸ é‹è¡Œæ™‚é–“: ${uptime}</div>
                            ${device.shelves.length > 0 ? `
                                <div style="margin-top: 8px;">
                                    <strong>å¯ç”¨è²¨æ¶:</strong> 
                                    ${device.shelves.map(s => `<span class="badge badge-info" style="margin: 2px;">${s}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" style="padding: 8px 20px;">
                        é¸æ“‡æ­¤è¨­å‚™
                    </button>
                </div>
            `;
            
            devicesList.appendChild(card);
        });
    }
    
    function selectDevice(index, cardElement) {
        const device = discoveredDevices[index];
        
        // å¡«å…¥è¡¨å–®
        document.getElementById('device_id').value = device.device_id;
        document.getElementById('device_name').value = device.device_name;
        
        // æ¨™è¨˜ç‚ºå¾æ¢æ¸¬ä¾†çš„è¨­å‚™ï¼ˆè¨­ç‚ºåœ¨ç·šç‹€æ…‹ï¼‰
        document.getElementById('from_discovery').value = 'true';
        
        // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('.device-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // æ·»åŠ é¸ä¸­ç‹€æ…‹
        cardElement.classList.add('selected');
        
        // æ»¾å‹•åˆ°è¡¨å–®
        document.querySelector('form').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function formatUptime(ms) {
        const seconds = Math.floor(ms / 1000);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours}æ™‚${minutes}åˆ†${secs}ç§’`;
    }
</script>
{% endblock %}

