{% extends "base.html" %}

{% block title %}æ–°å¢è¨­å‚™ - æ™ºèƒ½å€‰å„²ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 10px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .page-header h2 {
        margin: 0 0 10px 0;
        font-size: 28px;
        font-weight: 600;
    }
    
    .info-box {
        background: linear-gradient(135deg, #e7f3ff 0%, #f0e7ff 100%);
        padding: 25px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        margin-bottom: 30px;
    }
    
    .info-box h4 {
        color: #667eea;
        margin: 0 0 15px 0;
        font-size: 18px;
        font-weight: 600;
    }
    
    .info-box ol {
        margin: 0;
        padding-left: 20px;
        color: #495057;
        line-height: 1.8;
    }
    
    .scan-section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .scan-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .scan-header h3 {
        color: #2d3748;
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .device-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 2px solid #e9ecef;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .device-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }
    
    .device-card.selected {
        border-color: #667eea;
        background: linear-gradient(135deg, #f0f4ff 0%, #faf0ff 100%);
    }
    
    .device-info {
        flex: 1;
    }
    
    .device-title {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .device-id {
        font-family: 'Courier New', monospace;
        font-size: 1.2em;
        font-weight: 700;
        color: #2d3748;
    }
    
    .device-details {
        color: #6c757d;
        font-size: 0.95em;
        line-height: 1.8;
    }
    
    .device-details div {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .shelves-list {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
    }
    
    .form-section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .form-section h3 {
        color: #2d3748;
        margin: 0 0 25px 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .scan-status {
        background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .no-devices {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
    }
    
    .no-devices strong {
        color: #856404;
        font-size: 16px;
    }
    
    .no-devices p {
        color: #856404;
        margin: 10px 0 5px 0;
    }
    
    .no-devices ul {
        color: #856404;
        padding-left: 25px;
        margin: 5px 0 0 0;
    }
</style>

<div class="page-header">
    <h2>â• æ–°å¢å€‰å„²è¨­å‚™</h2>
    <p>é€éè‡ªå‹•æ¢æ¸¬æˆ–æ‰‹å‹•è¼¸å…¥æ–¹å¼æ–°å¢ ESP32 æ„Ÿæ¸¬è¨­å‚™</p>
</div>

{% if error %}
<div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c2c7 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545; margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">âŒ</span>
        <div>
            <strong style="color: #721c24; font-size: 16px;">æ“ä½œå¤±æ•—</strong>
            <p style="color: #721c24; margin: 5px 0 0 0;">{{ error }}</p>
        </div>
    </div>
</div>
{% endif %}

<div class="info-box">
    <h4>ğŸ’¡ è¨­å‚™æ–°å¢æµç¨‹</h4>
    <ol style="line-height: 2;">
        <li><strong>æ­¥é©Ÿ 1ï¼šæ¢æ¸¬è¨­å‚™</strong> - é»æ“Šã€Œæƒæè¨­å‚™ã€æŒ‰éˆ•ï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼ç¾æ‰€æœ‰åœ¨ç·šçš„ ESP32S3 è¨­å‚™</li>
        <li><strong>æ­¥é©Ÿ 2ï¼šé¸æ“‡è¨­å‚™</strong> - é»æ“Šã€Œé¸æ“‡æ­¤è¨­å‚™ã€æŒ‰éˆ•ï¼Œç³»çµ±æœƒè‡ªå‹•å¡«å…¥è¨­å‚™è³‡è¨Šåˆ°ä¸‹æ–¹è¡¨å–®</li>
        <li><strong>æ­¥é©Ÿ 3ï¼šç¢ºèªè³‡è¨Š</strong> - æª¢æŸ¥ä¸¦ä¿®æ”¹è¨­å‚™åç¨±ã€æŒ‡å®šè² è²¬å€åŸŸï¼ˆå¯é¸ï¼‰</li>
        <li><strong>æ­¥é©Ÿ 4ï¼šå®Œæˆæ–°å¢</strong> - é»æ“Šã€Œâœ“ æ–°å¢è¨­å‚™ã€æŒ‰éˆ•å®Œæˆæ–°å¢æ“ä½œ</li>
    </ol>
    <p style="color: #495057; margin: 10px 0 0 0; font-size: 14px;">
        ğŸ’¡ <strong>æç¤ºï¼š</strong>å¦‚æœè‡ªå‹•æ¢æ¸¬å¤±æ•—ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ä¸‹æ–¹è¡¨å–®æ‰‹å‹•è¼¸å…¥è¨­å‚™è³‡è¨Šã€‚
    </p>
</div>

<!-- è¨­å‚™æ¢æ¸¬å€åŸŸ -->
<div class="scan-section">
    <div class="scan-header">
        <h3>ğŸ” æ­¥é©Ÿ 1 & 2ï¼šæ¢æ¸¬ä¸¦é¸æ“‡è¨­å‚™</h3>
        <button onclick="scanDevices()" id="scan-btn" class="btn btn-primary">
            <span id="scan-text">ğŸ“¡ æƒæè¨­å‚™</span>
        </button>
    </div>
    
    <div id="scan-status" class="scan-status" style="display: none;">
        <div class="spinner" style="width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span id="scan-status-text" style="font-weight: 500;">æ­£åœ¨æƒæç¶²è·¯ä¸­çš„è¨­å‚™...</span>
    </div>
    
    <div id="discovered-devices" style="display: none;">
        <h4 style="color: #495057; margin-bottom: 15px; font-size: 16px;">ğŸ“± ç™¼ç¾çš„è¨­å‚™ï¼š</h4>
        <div id="devices-list"></div>
    </div>
    
    <div id="no-devices" class="no-devices" style="display: none;">
        <strong>âš ï¸ æœªç™¼ç¾ä»»ä½•è¨­å‚™</strong>
        <p>è«‹æª¢æŸ¥ä»¥ä¸‹äº‹é …ï¼š</p>
        <ul>
            <li>ESP32S3 å·²é–‹æ©Ÿä¸¦é€£æ¥åˆ° WiFi</li>
            <li>ESP32S3 å·²æˆåŠŸé€£æ¥åˆ° MQTT Broker</li>
            <li>ESP32S3 éŸŒé«”ç‰ˆæœ¬æ­£ç¢ºä¸”é‹è¡Œæ­£å¸¸</li>
            <li>ç¶²è·¯ç’°å¢ƒå…è¨±è¨­å‚™é€šè¨Š</li>
        </ul>
    </div>
</div>

<!-- æ‰‹å‹•æ–°å¢è¡¨å–® -->
<div class="form-section">
    <h3>ğŸ“ æ­¥é©Ÿ 3 & 4ï¼šç¢ºèªè³‡è¨Šä¸¦æ–°å¢è¨­å‚™</h3>
    <p style="color: #6c757d; margin: 10px 0 25px 0; font-size: 14px;">
        å¦‚æœæ‚¨é¸æ“‡äº†ä¸Šæ–¹çš„è¨­å‚™ï¼Œè³‡è¨Šå·²è‡ªå‹•å¡«å…¥ã€‚è«‹ç¢ºèªç„¡èª¤å¾Œé»æ“Šã€Œæ–°å¢è¨­å‚™ã€æŒ‰éˆ•å®Œæˆã€‚
    </p>
    
    <form method="POST" style="max-width: 600px;">
        <input type="hidden" id="from_discovery" name="from_discovery" value="false">
        
        <div class="form-group">
            <label for="device_id">è¨­å‚™ ID * <small style="color: #6c757d;">(å¿…é ˆå”¯ä¸€ï¼Œå·²è‡ªå‹•å¡«å…¥æˆ–æ‰‹å‹•è¼¸å…¥)</small></label>
            <input type="text" id="device_id" name="device_id" required 
                   placeholder="ä¾‹å¦‚: ESP32S3_A1B2C3D4"
                   style="font-family: 'Courier New', monospace;">
        </div>
        
        <div class="form-group">
            <label for="device_name">è¨­å‚™åç¨± * <small style="color: #6c757d;">(å¯ä¿®æ”¹)</small></label>
            <input type="text" id="device_name" name="device_name" required 
                   placeholder="ä¾‹å¦‚: å€‰åº« A å€æ„Ÿæ¸¬å™¨">
        </div>
        
        <div class="form-group">
            <label for="location">è² è²¬å€åŸŸ <small style="color: #6c757d;">(é¸å¡«ï¼Œå»ºè­°ç¾åœ¨æŒ‡å®š)</small></label>
            <input type="text" id="location" name="location" 
                   placeholder="ä¾‹å¦‚: å€‰åº« A å€">
        </div>
        
        <div class="action-buttons" style="margin-top: 30px;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 40px; font-size: 16px; font-weight: 600;">
                âœ“ æ–°å¢è¨­å‚™
            </button>
            <a href="{{ url_for('devices') }}" class="btn" style="background: #6c757d; color: white; padding: 12px 30px;">
                å–æ¶ˆ
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_script %}
<script>
    let discoveredDevices = [];
    
    async function scanDevices() {
        const scanBtn = document.getElementById('scan-btn');
        const scanStatus = document.getElementById('scan-status');
        const discoveredDiv = document.getElementById('discovered-devices');
        const noDevicesDiv = document.getElementById('no-devices');
        const devicesList = document.getElementById('devices-list');
        
        // éš±è—ä¹‹å‰çš„çµæœ
        discoveredDiv.style.display = 'none';
        noDevicesDiv.style.display = 'none';
        devicesList.innerHTML = '';
        
        // é¡¯ç¤ºæƒæç‹€æ…‹
        scanBtn.disabled = true;
        scanStatus.style.display = 'flex';
        document.getElementById('scan-text').textContent = 'æƒæä¸­...';
        
        try {
            const response = await fetch('/api/devices/discover');
            const data = await response.json();
            
            if (data.success) {
                // âœ… é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯
                const stats = data.stats || {};
                const totalFound = stats.total_found || 0;
                const alreadyRegistered = stats.already_registered || 0;
                const newDevices = stats.new_devices || 0;
                
                // å¦‚æœæœ‰æ‰¾åˆ°å·²è¨»å†Šçš„è¨­å‚™ï¼Œé¡¯ç¤ºæç¤º
                if (alreadyRegistered > 0) {
                    const filterInfo = document.createElement('div');
                    filterInfo.style.cssText = 'background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); padding: 12px 16px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 15px; font-size: 14px;';
                    filterInfo.innerHTML = `
                        <strong>ğŸ“Š æ¢æ¸¬çµæœï¼š</strong><br>
                        ç™¼ç¾ <strong>${totalFound}</strong> å€‹åœ¨ç·šè¨­å‚™ï¼Œ
                        å…¶ä¸­ <strong>${alreadyRegistered}</strong> å€‹å·²åœ¨ç³»çµ±ä¸­ï¼ˆå·²è‡ªå‹•éæ¿¾ï¼‰ï¼Œ
                        <strong>${newDevices}</strong> å€‹æ–°è¨­å‚™å¯æ·»åŠ ã€‚
                    `;
                    
                    // æ’å…¥åˆ°ç™¼ç¾çš„è¨­å‚™åˆ—è¡¨ä¹‹å‰
                    if (newDevices > 0) {
                        discoveredDiv.insertBefore(filterInfo, discoveredDiv.firstChild);
                    } else {
                        noDevicesDiv.innerHTML = `
                            <p style="font-size: 1.1em;">âœ… æƒæå®Œæˆ</p>
                            <p>ç™¼ç¾ ${totalFound} å€‹åœ¨ç·šè¨­å‚™ï¼Œä½†éƒ½å·²åœ¨ç³»çµ±ä¸­ã€‚</p>
                            <p style="color: #666; font-size: 0.9em; margin-top: 15px;">
                                ğŸ’¡ å¦‚éœ€é‡æ–°æ·»åŠ è¨­å‚™ï¼Œè«‹å…ˆåœ¨è¨­å‚™ç®¡ç†é é¢åˆªé™¤èˆŠè¨­å‚™ã€‚
                            </p>
                        `;
                        noDevicesDiv.style.display = 'block';
                        scanBtn.disabled = false;
                        scanStatus.style.display = 'none';
                        document.getElementById('scan-text').textContent = 'ğŸ”„ é‡æ–°æƒæ';
                        return;
                    }
                }
                
                if (data.count > 0) {
                    discoveredDevices = data.devices;
                    displayDevices(data.devices);
                    discoveredDiv.style.display = 'block';
                } else {
                    noDevicesDiv.style.display = 'block';
                }
            } else {
                alert('âŒ è¨­å‚™æ¢æ¸¬å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                noDevicesDiv.style.display = 'block';
            }
        } catch (error) {
            alert('âŒ è¨­å‚™æ¢æ¸¬å¤±æ•—ï¼š' + error.message);
            noDevicesDiv.style.display = 'block';
        } finally {
            scanBtn.disabled = false;
            scanStatus.style.display = 'none';
            document.getElementById('scan-text').textContent = 'ğŸ”„ é‡æ–°æƒæ';
        }
    }
    
    function displayDevices(devices) {
        const devicesList = document.getElementById('devices-list');
        
        devices.forEach((device, index) => {
            const card = document.createElement('div');
            card.className = 'device-card';
            card.onclick = () => selectDevice(index, card);
            
            const uptime = formatUptime(device.uptime_ms);
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                    <div class="device-info">
                        <div class="device-title">
                            <span class="device-id">${device.device_id}</span>
                            <span class="badge badge-success">ğŸŸ¢ åœ¨ç·š</span>
                        </div>
                        <div class="device-details">
                            <div>ğŸ“± è¨­å‚™åç¨±: <strong>${device.device_name}</strong></div>
                            <div>ğŸ—‚ï¸ è²¨æ¶æ•¸é‡: <strong>${device.shelf_count}</strong> å€‹</div>
                            <div>ğŸ“¡ WiFi ä¿¡è™Ÿ: <strong>${device.wifi_signal || 'N/A'}</strong> dBm</div>
                            <div>â±ï¸ é‹è¡Œæ™‚é–“: <strong>${uptime}</strong></div>
                            ${device.shelves && device.shelves.length > 0 ? `
                                <div class="shelves-list">
                                    <strong>ğŸ—„ï¸ å·²å•Ÿç”¨è²¨æ¶:</strong><br>
                                    <div style="margin-top: 6px;">
                                        ${device.shelves.map(s => `<span class="badge badge-info" style="margin: 3px;">${s}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" style="padding: 10px 24px; white-space: nowrap;">
                        é¸æ“‡æ­¤è¨­å‚™ â†’
                    </button>
                </div>
            `;
            
            devicesList.appendChild(card);
        });
    }
    
    function selectDevice(index, cardElement) {
        const device = discoveredDevices[index];
        
        // å¡«å…¥è¡¨å–®
        document.getElementById('device_id').value = device.device_id;
        document.getElementById('device_name').value = device.device_name;
        
        // æ¨™è¨˜ç‚ºå¾æ¢æ¸¬ä¾†çš„è¨­å‚™ï¼ˆè¨­ç‚ºåœ¨ç·šç‹€æ…‹ï¼‰
        document.getElementById('from_discovery').value = 'true';
        
        // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('.device-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // æ·»åŠ é¸ä¸­ç‹€æ…‹
        cardElement.classList.add('selected');
        
        // é¡¯ç¤ºæˆåŠŸæç¤º
        const formSection = document.querySelector('.form-section');
        
        // å‰µå»ºæç¤ºè¨Šæ¯
        let existingAlert = document.getElementById('device-selected-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        const alert = document.createElement('div');
        alert.id = 'device-selected-alert';
        alert.style.cssText = 'background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 15px 20px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;';
        alert.innerHTML = `
            <span style="font-size: 24px;">âœ…</span>
            <div>
                <strong style="color: #155724; font-size: 15px;">è¨­å‚™å·²é¸æ“‡</strong>
                <p style="color: #155724; margin: 5px 0 0 0; font-size: 14px;">
                    å·²è‡ªå‹•å¡«å…¥ <strong>${device.device_id}</strong> çš„è³‡è¨Šï¼Œè«‹ç¢ºèªä¸¦ä¿®æ”¹ï¼ˆå¦‚éœ€è¦ï¼‰ï¼Œç„¶å¾Œé»æ“Šä¸‹æ–¹ã€Œæ–°å¢è¨­å‚™ã€æŒ‰éˆ•å®Œæˆã€‚
                </p>
            </div>
        `;
        
        formSection.insertBefore(alert, formSection.firstChild);
        
        // æ»¾å‹•åˆ°è¡¨å–®
        setTimeout(() => {
            formSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }, 100);
        
        // é«˜äº®è¡¨å–®
        formSection.style.boxShadow = '0 0 0 4px rgba(40, 167, 69, 0.3)';
        setTimeout(() => {
            formSection.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
        }, 2000);
        
        // 3ç§’å¾Œæ·¡å‡ºæç¤º
        setTimeout(() => {
            alert.style.transition = 'opacity 0.5s';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        }, 3000);
    }
    
    function formatUptime(ms) {
        const seconds = Math.floor(ms / 1000);
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours}æ™‚ ${minutes}åˆ† ${secs}ç§’`;
    }
</script>
{% endblock %}
