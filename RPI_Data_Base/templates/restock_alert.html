{% extends "base.html" %}

{% block title %}è£œè²¨æé†’ - è³‡æ–™åº«ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
        <h2>âš ï¸ è£œè²¨æé†’</h2>
        <p style="color: #6c757d; font-size: 0.9em; margin: 5px 0 0 0;">
            <span id="auto-refresh-status">ğŸ”„ è‡ªå‹•æ›´æ–°ä¸­</span> Â· æ¯ 30 ç§’åˆ·æ–°ä¸€æ¬¡
        </p>
    </div>
    <button onclick="manualRefresh()" class="btn btn-primary">
        ğŸ”„ ç«‹å³åˆ·æ–°
    </button>
</div>

<div style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
    <h4 style="color: #0c5460; margin: 0 0 10px 0;">ğŸ’¡ æ™ºèƒ½æé†’</h4>
    <ul style="margin: 0; padding-left: 20px; color: #0c5460;">
        <li>æ­¤é é¢é¡¯ç¤º<strong>å·²é…ç½®å•†å“ä½†ç›®å‰ç‚ºç©º</strong>çš„è²¨æ¶</li>
        <li>åªæœ‰<strong>å·²å•Ÿç”¨</strong>ä¸”<strong>å ç”¨ç‹€æ…‹ç‚ºç©º</strong>çš„è²¨æ¶æ‰æœƒå‡ºç¾</li>
        <li><strong>âœ¨ ç•¶å•†å“è¢«è£œè²¨å¾Œï¼ˆæ•¸é‡ > 0ï¼‰ï¼Œæé†’æœƒè‡ªå‹•æ¶ˆå¤±</strong></li>
        <li>ç³»çµ±æ¯ 5 ç§’è‡ªå‹•åˆ·æ–°ï¼Œä¹Ÿå¯é»æ“Šã€Œç«‹å³åˆ·æ–°ã€æ‰‹å‹•æ›´æ–°</li>
        <li>å¯æŒ‰<strong>å€åŸŸ</strong>æˆ–<strong>å•†å“åç¨±</strong>ç¯©é¸éœ€è¦è£œè²¨çš„é …ç›®</li>
    </ul>
</div>

<!-- çµ±è¨ˆå¡ç‰‡ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div class="stat-card" style="border-left-color: #dc3545;">
        <h3>éœ€è£œè²¨é …ç›®</h3>
        <div class="value" id="stat-alerts" style="color: #dc3545;">-</div>
    </div>
</div>

<!-- ç¯©é¸è¡¨å–® -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
    <h4 style="margin-bottom: 15px;">ğŸ” ç¯©é¸æ¢ä»¶</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div class="form-group">
            <label for="filter-location">å€åŸŸ</label>
            <select id="filter-location" onchange="applyFilters()">
                <option value="">-- æ‰€æœ‰å€åŸŸ --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="filter-product">å•†å“åç¨±</label>
            <select id="filter-product" onchange="applyFilters()">
                <option value="">-- æ‰€æœ‰å•†å“ --</option>
            </select>
        </div>
    </div>
</div>

<!-- è£œè²¨åˆ—è¡¨ -->
<div id="alert-container">
    <div style="text-align: center; padding: 40px; color: #999;">
        <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #dc3545; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p>æ­£åœ¨è¼‰å…¥è£œè²¨æé†’...</p>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .alert-card {
        background: white;
        border-left: 4px solid #dc3545;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 12px;
        transition: all 0.3s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .alert-card:hover {
        box-shadow: 0 3px 6px rgba(220, 53, 69, 0.15);
        transform: translateX(2px);
    }
    
    .alert-main {
        display: flex;
        gap: 15px;
        align-items: center;
        flex: 1;
    }
    
    .alert-shelf-id {
        font-size: 1.1em;
        font-weight: 600;
        color: #dc3545;
        min-width: 70px;
    }
    
    .alert-location {
        font-size: 0.95em;
        color: #17a2b8;
        font-weight: 500;
        min-width: 100px;
    }
    
    .alert-product {
        font-size: 1em;
        color: #2d3748;
        font-weight: 500;
        flex: 1;
    }
    
    .alert-time {
        font-size: 0.9em;
        color: #6c757d;
        min-width: 110px;
        text-align: right;
    }
    
    .alert-badge {
        background: #dc3545;
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .alert-list-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
        gap: 12px;
    }
    
    @media (max-width: 768px) {
        .alert-list-container {
            grid-template-columns: 1fr;
        }
        
        .alert-main {
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
        }
        
        .alert-time, .alert-location {
            text-align: left;
        }
    }
</style>

<script>
let autoRefreshInterval = null;

// è¼‰å…¥æ•¸æ“š
async function loadData() {
    try {
        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        const statusElement = document.getElementById('auto-refresh-status');
        if (statusElement) {
            statusElement.innerHTML = 'ğŸ”„ æ›´æ–°ä¸­...';
            statusElement.style.color = '#17a2b8';
        }
        
        // æ§‹å»ºæŸ¥è©¢åƒæ•¸
        const params = new URLSearchParams({
            location: document.getElementById('filter-location').value,
            product_name: document.getElementById('filter-product').value
        });
        
        const response = await fetch(`/api/restock_alert?${params}`);
        const result = await response.json();
        
        if (result.success) {
            updateStatistics(result.stats);
            updateAlertList(result.alerts);
            updateFilterOptions(result.filters);
            
            // æ›´æ–°æˆåŠŸæç¤º
            if (statusElement) {
                statusElement.innerHTML = 'âœ… å·²æ›´æ–°';
                statusElement.style.color = '#28a745';
                setTimeout(() => {
                    statusElement.innerHTML = 'ğŸ”„ è‡ªå‹•æ›´æ–°ä¸­';
                    statusElement.style.color = '#6c757d';
                }, 2000);
            }
        } else {
            console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', result.error);
            if (statusElement) {
                statusElement.innerHTML = 'âŒ æ›´æ–°å¤±æ•—';
                statusElement.style.color = '#dc3545';
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        const statusElement = document.getElementById('auto-refresh-status');
        if (statusElement) {
            statusElement.innerHTML = 'âŒ é€£æ¥éŒ¯èª¤';
            statusElement.style.color = '#dc3545';
        }
    }
}

// æ›´æ–°çµ±è¨ˆè³‡è¨Š
function updateStatistics(stats) {
    document.getElementById('stat-alerts').textContent = stats.total_alerts || 0;
}

// æ›´æ–°è£œè²¨åˆ—è¡¨
function updateAlertList(alerts) {
    const container = document.getElementById('alert-container');
    
    if (!alerts || alerts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p style="font-size: 1.2em;">âœ… å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éœ€è¦è£œè²¨çš„é …ç›®</p>
                <p style="color: #6c757d; margin-top: 10px;">
                    æ‰€æœ‰å·²é…ç½®å•†å“çš„è²¨æ¶ç‹€æ…‹è‰¯å¥½<br>
                    <small style="color: #28a745; font-weight: 500;">
                        ğŸ’¡ å·²è£œè²¨çš„è²¨æ¶æœƒè‡ªå‹•å¾æ­¤åˆ—è¡¨ä¸­ç§»é™¤
                    </small>
                </p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <p style="color: #6c757d; margin: 0;">
                å…±ç™¼ç¾ <strong style="color: #dc3545;">${alerts.length}</strong> å€‹è²¨æ¶éœ€è¦è£œè²¨
            </p>
            <p style="color: #28a745; font-size: 0.9em; margin: 0;">
                ğŸ’¡ è£œè²¨å¾Œæé†’æœƒè‡ªå‹•æ¶ˆå¤±
            </p>
        </div>
        <div class="alert-list-container">
    `;
    
    alerts.forEach(alert => {
        const lastUpdate = alert.last_update ? formatTime(alert.last_update) : 'ç„¡æ•¸æ“š';
        const location = alert.location || 'æœªåˆ†é…';
        
        html += `
            <div class="alert-card">
                <div class="alert-main">
                    <div class="alert-shelf-id">ğŸ—‚ï¸ ${alert.shelf_id}</div>
                    <div class="alert-location">ğŸ“ ${location}</div>
                    <div class="alert-product">ğŸ“¦ ${alert.product_name}</div>
                    <div class="alert-time">ğŸ•’ ${lastUpdate}</div>
                </div>
                <span class="alert-badge">éœ€è£œè²¨</span>
            </div>
        `;
    });
    
    html += '</div>';
    
    container.innerHTML = html;
}

// æ›´æ–°ç¯©é¸é¸é …
function updateFilterOptions(filters) {
    // æ›´æ–°å€åŸŸåˆ—è¡¨
    const locationSelect = document.getElementById('filter-location');
    const currentLocation = locationSelect.value;
    locationSelect.innerHTML = '<option value="">-- æ‰€æœ‰å€åŸŸ --</option>';
    if (filters.locations) {
        filters.locations.forEach(location => {
            if (location) {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                if (location === currentLocation) option.selected = true;
                locationSelect.appendChild(option);
            }
        });
    }
    
    // æ›´æ–°å•†å“åˆ—è¡¨
    const productSelect = document.getElementById('filter-product');
    const currentProduct = productSelect.value;
    productSelect.innerHTML = '<option value="">-- æ‰€æœ‰å•†å“ --</option>';
    if (filters.products) {
        filters.products.forEach(product => {
            if (product) {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                if (product === currentProduct) option.selected = true;
                productSelect.appendChild(option);
            }
        });
    }
}

// æ ¼å¼åŒ–æ™‚é–“
function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'å‰›å‰›';
    if (diffMins < 60) return `${diffMins} åˆ†é˜å‰`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours} å°æ™‚å‰`;
    
    return date.toLocaleString('zh-TW', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// æ‡‰ç”¨ç¯©é¸
function applyFilters() {
    loadData();
}

// æ‰‹å‹•åˆ·æ–°
function manualRefresh() {
    loadData();
}

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
    loadData();
    
    // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
    autoRefreshInterval = setInterval(loadData, 5000);
});

// é é¢å¸è¼‰æ™‚æ¸…é™¤å®šæ™‚å™¨
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}

